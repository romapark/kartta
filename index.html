<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ski Resort Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="tyyli.css" />
  <link rel="stylesheet" href="nouislider.css">

</head>
<body>

  <!-- 🔎 Haku -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Search resort...">
    <ul id="suggestions"></ul>
  </div>

  <div id="container">

    <!-- 🧩 Suodattimet -->
    <div id="filterBox">
      <div id="filters-content">
        <fieldset>
          <legend>Ski Resort</legend>
          <label for="countryInput">Select country:</label><br>
          <input id="countryInput" type="text" placeholder="Country..." list="countryList" />
          <datalist id="countryList"></datalist>
        </fieldset>

        <fieldset>
          <legend>Slopes</legend>

          <strong>Lift count</strong>
          <div id="lift-slider"></div>

          <strong>Run count</strong>
          <p>All</p>
          <div id="run-slider"></div>
          <p>Difficulty</p>
          <div id="green-run-slider"></div>
          <div id="blue-run-slider"></div>
          <div id="red-run-slider"></div>
          <div id="black-run-slider"></div>

          <strong>Resort height</strong>
          <div id="vertical-m-slider"></div>

        </fieldset>

        <fieldset>
          <legend>Parks</legend>
          <strong>Difficulty</strong><br>
          <label><input type="checkbox" id="s_park"> S</label>
          <label><input type="checkbox" id="m_park"> M</label>
          <label><input type="checkbox" id="l_park"> L</label>
          <label><input type="checkbox" id="xl_park"> XL</label><br>

          <strong>Condition</strong>
          <div id="park-condition-slider"></div>

          <strong>Other features</strong><br>
          <label><input type="checkbox" id="superpipe"> Superpipe</label><br>
          <label><input type="checkbox" id="minipipe"> Minipipe</label><br>
          <label><input type="checkbox" id="moguls"> Moguls</label>
        </fieldset>

        <fieldset>
          <legend>Transport</legend>
        </fieldset>
      </div>

      <!--<button id="filterButton">FILTER</button>-->
    </div>

    <!-- ℹ️ InfoBox -->
    <div id="infoBox">
      <span id="closeInfoButton">&times;</span>
      <div id="infoContent">

        <h2 id="resort-name"></h2>
        <p id="overall-description-text"></p>

        <fieldset>
          <h3>Resort info</h3>
          <div class="alingn-left-right-flexbox"><strong>Season:</strong> <span id="season-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Resort height:</strong> <span id="height-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Lift count:</strong> <span id="lift-count-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Run count:</strong> <span id="run-count-text"></span></div>
          <div id="run-container"> <span id="green-run-text"></span><span id="blue-run-text"></span><span id="red-run-text"></span><span id="black-run-text"></span></div>
        </fieldset>

        <fieldset>
          <h3>Terrain park</h3>
          <div class="alingn-left-right-flexbox"><strong>Level:</strong> <div><span id="s-text"></span> <span id="m-text"></span> <span id="l-text"></span> <span id="xl-text"></span></div></div>
          <div class="alingn-left-right-flexbox"><strong>Condition:</strong> <span id="condition-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Other features:</strong> <div class="right-content-flexbox"><span id="superpipe-text"></span> <span id="minipipe-text"></span> <span id="moguls-text"></span></div></div>
          <p id="park-description-text"></p>
        </fieldset>

        <fieldset>
          <h3>Access</h3>
          <div class="alingn-left-right-flexbox"><strong>Public transportation:</strong> <span id="has-transport-text"></span></div>
        </fieldset>


      </div>
    </div>

    <div id="map"></div>

  </div>

  <!-- 📜 Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <!-- ⚙️ Sovelluslogiikka -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {

    // === KARTTA ===
    const map = L.map('map', { zoomControl: false }).setView([60.17, 24.94], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '© OpenStreetMap'
    }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    // === APUFUNKTIOT ===
    const $ = id => document.getElementById(id);
    const setHTML = (id, html) => { $(id).innerHTML = html; };
    const inRange = (v, min, max) => v >= min && v <= max;
    const getRange = s => s.noUiSlider.get().map(Number);

    // === ELEMENTIT ===
    const infoBox = $('infoBox');
    const searchInput = $('searchInput');
    const suggestions = $('suggestions');
    const datalist = $('countryList');
    const closeBtn = $('closeInfoButton');
    closeBtn.onclick = () => infoBox.classList.remove('visible');

    // === DATA ===
    let data = [], markers = [];
    try {
      data = await (await fetch('ski_resorts.json')).json();
    } catch (err) {
      console.error("JSON lataus epäonnistui:", err);
      return;
    }

    // === MARKKERIT ===
    data.forEach(r => markers.push(createMarker(r).addTo(map)));
    const countries = [...new Set(data.map(r => r.country))].sort();
    datalist.innerHTML = countries.map(c => `<option value="${c}">`).join('');

    // === SLIDERIT ===
    const SLIDER_CONFIGS = [
      { id: 'vertical-m-slider', range:[0,3000], step:50 },
      { id: 'lift-slider', range:[0,170], step:1 },
      { id: 'run-slider', range:[0,170], step:1 },
      { id: 'green-run-slider', range:[0,170], step:1 },
      { id: 'blue-run-slider', range:[0,170], step:1 },
      { id: 'red-run-slider', range:[0,170], step:1 },
      { id: 'black-run-slider', range:[0,170], step:1 },
      { id: 'park-condition-slider', range:[1,3], step:1 },
    ];

    const sliders = {};
    SLIDER_CONFIGS.forEach(cfg => {
      const el = $(cfg.id);
      sliders[cfg.id] = createCustomSlider(el, cfg.range, cfg.step);
      sliders[cfg.id].on('update', applyFilters);
    });

    // === CHECKBOXIT ===
    const FILTER_CHECKBOXES = ['xl_park','l_park','m_park','s_park','superpipe','minipipe','moguls'];
    document.querySelectorAll('#filterBox input').forEach(el =>
      el.addEventListener('input', applyFilters)
    );

    // === HAKU ===
    searchInput.addEventListener('input', handleSearch);

    // === SUODATUS ===
    function applyFilters() {
      const country = $('countryInput').value.trim().toLowerCase();
      const filters = Object.fromEntries(FILTER_CHECKBOXES.map(id => [id, $(id).checked]));

      // hae kaikki slider-arvot yhdellä rivillä
      const vals = Object.fromEntries(Object.entries(sliders)
        .map(([k,s]) => [k, getRange(s).map(Number)]));

      markers.forEach(m => {
        const d = m.data;

        const matchCountry = !country || d.country?.toLowerCase().includes(country);
        const matchParks = Object.entries(filters).every(([k, v]) => !v || d[k]);
        const vertical = d.vertical_m ?? 0;
        const lift = d.lift_count ?? 0;
        const run = d.run_count ?? 0;
        const green = d.green_run ?? 0;
        const blue = d.blue_run ?? 0;
        const red = d.red_run ?? 0;
        const black = d.black_run ?? 0;
        const condition = d.park_condition ?? 1;

        const matches =
          inRange(vertical, ...vals['vertical-m-slider']) &&
          inRange(lift, ...vals['lift-slider']) &&
          inRange(run, ...vals['run-slider']) &&
          inRange(green, ...vals['green-run-slider']) &&
          inRange(blue, ...vals['blue-run-slider']) &&
          inRange(red, ...vals['red-run-slider']) &&
          inRange(black, ...vals['black-run-slider']) &&
          inRange(condition, ...vals['park-condition-slider']);

        (matchCountry && matchParks && matches) ? m.addTo(map) : map.removeLayer(m);
      });

      const visible = markers.filter(m => map.hasLayer(m));
      if (visible.length) map.fitBounds(L.featureGroup(visible).getBounds());
    }

    // === SLIDERIN LUONTI ===
    function createCustomSlider(element, [min, max], step = 1) {
      noUiSlider.create(element, {
        start: [min, max], connect: true, range: { min, max }, step,
        tooltips: [true, true],
        format: { to: v => Math.round(v), from: v => Number(v) }
      });

      // Tooltip näkyy liikutettaessa ja katoaa 1s jälkeen
      let hideTimeout;
      element.noUiSlider.on('start', (_, handle) => {
        const h = element.querySelectorAll('.noUi-handle')[handle];
        h.classList.add('noUi-active');
        clearTimeout(hideTimeout);
      });
      element.noUiSlider.on('end', (_, handle) => {
        const h = element.querySelectorAll('.noUi-handle')[handle];
        hideTimeout = setTimeout(() => h.classList.remove('noUi-active'), 1000);
      });

      return element.noUiSlider;
    }

    // === MARKKERIN LUONTI ===
    function createMarker(r) {
      const marker = L.circleMarker([r.lat, r.lon], {
        radius: 4, color: '#0074D9', fillColor: '#0074D9', fillOpacity: 0.7
      });
      marker.data = r;
      marker.on('click', () => showInfo(r));
      return marker;
    }

    // === INFOBOX ===
    function showInfo(r) {
      setHTML("resort-name", r.name);
      setHTML("overall-description-text", r.overall_description);
      setHTML("season-text", `${r.season_start} – ${r.season_end}`);
      setHTML("height-text", `${r.vertical_m}m`);
      setHTML("lift-count-text", r.lift_count);
      setHTML("run-count-text", r.run_count);

      ['green','blue','red','black'].forEach(c => setDiamond(`${c}-run-text`, r[`${c}_run`], c));
      ['s','m','l','xl'].forEach(k => setCheck(`${k}-text`, r[`${k}_park`], k.toUpperCase()));
      showStars("condition-text", r.park_condition, 3);
      ['superpipe','minipipe','moguls'].forEach(k => setCheck(`${k}-text`, r[k], k));
      setHTML("park-description-text", r.park_description);
      setCheck("has-transport-text", r.has_public_trans, "", false);

      infoBox.classList.add('visible');
    }

    function setDiamond(id, val, color) {
      setHTML(id, val ? `<span class='diamond ${color}'>&#9670;</span> ${val}` : "");
    }

    function setCheck(id, val, label, hideFalse = true) {
      if (val === true) setHTML(id, `<span style="color:green">✔</span> ${label}`);
      else if (!hideFalse && val === false) setHTML(id, `<span style="color:red">✘</span> ${label}`);
      else setHTML(id, "");
    }

    function showStars(id, value, max = 3) {
      if (!value) return setHTML(id, "n/a");
      setHTML(id, Array.from({length: max}, (_, i) =>
        `<span style="color:${i < value ? 'gold' : '#ccc'}; font-size:1.2em;">${i < value ? '★' : '☆'}</span>`
      ).join(''));
    }

    // === HAKU ===
    function handleSearch() {
      const query = searchInput.value.toLowerCase().trim();
      suggestions.innerHTML = '';
      if (!query) return;

      const matches = markers.filter(m => m.data.name?.toLowerCase().includes(query))
        .sort((a, b) => a.data.name.localeCompare(b.data.name)).slice(0, 10);

      if (!matches.length) {
        suggestions.innerHTML = '<li class="no-results">Ei tuloksia</li>';
        return;
      }

      matches.forEach(m => {
        const li = document.createElement('li');
        li.textContent = m.data.name;
        li.onclick = () => selectMarker(m);
        suggestions.appendChild(li);
      });
    }

    function selectMarker(marker) {
      suggestions.innerHTML = '';
      searchInput.value = marker.data.name;
      map.setView([marker.data.lat, marker.data.lon], 14);
      marker.fire('click');
    }

    // === Ensimmäinen suodatus ===
    applyFilters();

  });
  </script>


</body>
</html>