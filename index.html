<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ski Resort Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="tyyli.css" />
  <link rel="stylesheet" href="nouislider.css">

</head>
<body>
  <div id="container">

    <!-- 🧩 Suodattimet -->
    <div id="filterBox">

      <div class="navbar-top">
        <strong>LOGO</strong>
      </div>

      <div id="filters-content">

        <h2>FILTERS</h2>

        <fieldset>
          <legend>RESORT</legend>

          <label for="countryInput">Select country:</label><br>
          <input id="countryInput" type="text" placeholder="Country..." list="countryList" />
          <datalist id="countryList"></datalist>

          <span>Open</span>
          <div class="month-container">
            <div class="month-column">
              <label><input type="checkbox" class="month-checkbox" value="1"> JAN</label>
              <label><input type="checkbox" class="month-checkbox" value="2"> FEB</label>
              <label><input type="checkbox" class="month-checkbox" value="3"> MAR</label>
              <label><input type="checkbox" class="month-checkbox" value="4"> APR</label>
              <label><input type="checkbox" class="month-checkbox" value="5"> MAY</label>
              <label><input type="checkbox" class="month-checkbox" value="6"> JUN</label>
            </div>
            <div class="month-column">
              <label><input type="checkbox" class="month-checkbox" value="7"> JUL</label>
              <label><input type="checkbox" class="month-checkbox" value="8"> AUG</label>
              <label><input type="checkbox" class="month-checkbox" value="9"> SEP</label>
              <label><input type="checkbox" class="month-checkbox" value="10"> OCT</label>
              <label><input type="checkbox" class="month-checkbox" value="11"> NOV</label>
              <label><input type="checkbox" class="month-checkbox" value="12"> DEC</label>
            </div>
          </div>

        </fieldset>

        <fieldset>
          <legend>SLOPES</legend>

          <div class = "chapter">
            <div class="alingn-left-right-flexbox"><span>Lift count</span><span id ="lift-slider-value"></span></div>
            <div class="slider" id="lift-slider"></div>
          </div>

          <div class = "chapter">
            <div class="alingn-left-right-flexbox"><span>Run count</span><span id ="run-slider-value"></span></div>
            <div class="slider" id="run-slider"></div>
          </div>

          <div class = "chapter">
            <div class="alingn-left-right-flexbox"><span>Resort height</span> <div><span id ="vertical-slider-value"></span><span>m</span></div></div>
            <div class="slider" id="vertical-m-slider"></div>
          </div>

        </fieldset>

        <fieldset>
          <legend>PARKS</legend>

          <div class = "chapter">
            <span>Level</span><br>
            <label><input type="checkbox" id="s_park"> S</label>
            <label><input type="checkbox" id="m_park"> M</label>
            <label><input type="checkbox" id="l_park"> L</label>
            <label><input type="checkbox" id="xl_park"> XL</label><br>
          </div>

          <div class = "chapter">
            <span>Park condition</span><br>
            <label><input type="checkbox" value="1" class="park-condition-checkbox"> ★★★ Good</label><br>
            <label><input type="checkbox" value="2" class="park-condition-checkbox"> ★★☆ Fair</label><br>
            <label><input type="checkbox" value="3" class="park-condition-checkbox"> ★☆☆ Poor</label><br>
            <label><input type="checkbox" value="none" class="park-condition-checkbox"> n/a</label><br>
          </div>

          <div class = "chapter">
            <span>Other features</span><br>
            <label><input type="checkbox" id="superpipe"> Superpipe</label><br>
            <label><input type="checkbox" id="minipipe"> Minipipe</label><br>
            <label><input type="checkbox" id="moguls"> Moguls</label>
          </div>
        </fieldset>

        <fieldset>
          <legend>TRANSPORT</legend>

          <span>Public transport</span><br>
            <label><input type="checkbox" id=""> Every hour or more often</label><br>
            <label><input type="checkbox" id=""> Several times a day</label><br>
            <label><input type="checkbox" id=""> Once a day</label><br>
            <label><input type="checkbox" id=""> Less often</label><br>

        </fieldset>
      </div>

      <!--<button id="filterButton">FILTER</button>-->
    </div>

    <!-- ℹ️ InfoBox -->
    <div id="infoBox">
      <span id="closeInfoButton">&times;</span>
      <div id="infoContent">

        <h2 id="resort-name"></h2>
        <p id="overall-description-text"></p>

        <fieldset>
          <h3>Resort info</h3>
          <div class="alingn-left-right-flexbox"><strong>Season:</strong> <span id="season-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Resort height:</strong> <span id="height-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Lift count:</strong> <span id="lift-count-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Run count:</strong> <span id="run-count-text"></span></div>
          <div id="run-container"> <span id="green-run-text"></span><span id="blue-run-text"></span><span id="red-run-text"></span><span id="black-run-text"></span></div>
        </fieldset>

        <fieldset>
          <h3>Terrain park</h3>
          <div class="alingn-left-right-flexbox"><strong>Level:</strong> <div><span id="s-text"></span> <span id="m-text"></span> <span id="l-text"></span> <span id="xl-text"></span></div></div>
          <div class="alingn-left-right-flexbox"><strong>Condition:</strong> <span id="condition-text"></span></div>
          <div class="alingn-left-right-flexbox"><strong>Other features:</strong> <div class="right-content-flexbox"><span id="superpipe-text"></span> <span id="minipipe-text"></span> <span id="moguls-text"></span></div></div>
          <p id="park-description-text"></p>
        </fieldset>

        <fieldset>
          <h3>Access</h3>
          <div class="alingn-left-right-flexbox"><strong>Public transportation:</strong> <span id="has-transport-text"></span></div>
        </fieldset>


      </div>
    </div>

    <!-- 🔎 Haku -->
    <div id="searchBox">
      <input type="text" id="searchInput" placeholder="Search...">
      <ul id="suggestions"></ul>
    </div>

    <div id="map"></div>

  </div>

  <!-- 📜 Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <!-- ⚙️ Sovelluslogiikka -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {

    // ==== KARTTA ====
    const map = L.map('map', { zoomControl: false }).setView([60.17, 24.94], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    // ==== ELEMENTIT ====
    const infoBox = document.getElementById('infoBox');
    const closeBtn = document.getElementById('closeInfoButton');
    const searchInput = document.getElementById('searchInput');
    const suggestions = document.getElementById('suggestions');
    const datalist = document.getElementById('countryList');
    const verticalSlider = document.getElementById('vertical-m-slider');
    const liftSlider = document.getElementById('lift-slider');
    const runSlider = document.getElementById('run-slider');
    const liftSliderValue = document.getElementById('lift-slider-value');
    const runSliderValue = document.getElementById('run-slider-value');
    const verticalSliderValue = document.getElementById('vertical-slider-value');
    const monthCheckboxes = document.querySelectorAll('.month-checkbox');



    closeBtn.onclick = () => infoBox.classList.remove('visible');

    let markers = [];
    let data = [];

    // ==== LADATAAN DATA ====
    try {
      data = await (await fetch('ski_resorts.json')).json();
    } catch (err) {
      console.error("JSON lataus epäonnistui:", err);
      return;
    }

    // 🔹 PRECOMPUTE SEASON MONTHS
    data.forEach(r => {
      const start = new Date(r.season_start).getMonth() + 1;
      const end = new Date(r.season_end).getMonth() + 1;
      const months = [];
      if (start <= end) {
        for (let m = start; m <= end; m++) months.push(m);
      } else {
        for (let m = start; m <= 12; m++) months.push(m);
        for (let m = 1; m <= end; m++) months.push(m);
      }
      r.seasonMonths = months;
    });

    // ==== MARKKERIT ====
    markers = data.map(r => createMarker(r));      // luodaan markerit
    const markerLayer = L.layerGroup(markers).addTo(map);

    // ==== TÄYTÄ MAAT DATALISTIIN ====
    const countries = [...new Set(data.map(r => r.country))].sort();
    datalist.innerHTML = countries.map(c => `<option value="${c}">`).join('');

    
    // ==== SLIDERIT ====
    createCustomSlider(verticalSlider, verticalSliderValue, [0, 3000], 0, 3000, 50);
    createCustomSlider(liftSlider, liftSliderValue, [0, 170], 0, 170, 1);
    createCustomSlider(runSlider, runSliderValue, [0, 170], 0, 170, 1);

    // Aja filtterit vasta, kun sliderit varmasti valmiit
    verticalSlider.noUiSlider.on('update', debounce(applyFilters));
    liftSlider.noUiSlider.on('update', debounce(applyFilters));
    runSlider.noUiSlider.on('update', debounce(applyFilters));

    // Ensimmäinen suodatus
    applyFilters();

    // ==== FILTTERIT ====
    document.querySelectorAll('#filterBox input').forEach(el => {
      if (el.type === "checkbox") {
        el.addEventListener('change', applyFilters);
      } else {
        el.addEventListener('input', applyFilters);
      }
    });

    document.querySelectorAll('.park-condition-checkbox')
    .forEach(cb => cb.addEventListener('change', debounce(applyFilters)));

    // ==== HAKU ====
    searchInput.addEventListener('input', debounce(handleSearch));

    // ==== FUNKTIOT ====
    function createCustomSlider(element, elementValue, start = [0, 100], min = 0, max = 100, step = 1, onUpdate = null) {
      noUiSlider.create(element, {
        start: start,
        connect: true,
        range: { min: min, max: max },
        step: step,
        format: {
          to: value => Math.round(value),
          from: value => Number(value)
        }
      });

      element.noUiSlider.on('update', (values) => {
        const [min, max] = values.map(v => Math.round(v));
        elementValue.textContent = `${min} – ${max}`;
      });

      /*  TOOLTIPIT
      element.noUiSlider.on('start', (values, handle) => {
        element.querySelectorAll('.noUi-handle')[handle].classList.add('noUi-active');
      });

      element.noUiSlider.on('end', (values, handle) => {
        element.querySelectorAll('.noUi-handle')[handle].classList.remove('noUi-active');
      });
      */

      // Päivitysfunktio
      if (onUpdate) {
        element.noUiSlider.on('update', onUpdate);
      }

      return element.noUiSlider;
    }

    
    function createMarker(r) {
      const marker = L.circleMarker([r.lat, r.lon], {
        radius: 4,
        color: '#0074D9',
        fillColor: '#0074D9',
        fillOpacity: 1
      });
      marker.data = r;
      marker.on('click', () => showInfo(r));
      return marker;
    }

    function showInfo(r) {
      const byId = id => document.getElementById(id);
      byId("resort-name").textContent = r.name;
      byId("overall-description-text").textContent = r.overall_description;
      byId("season-text").textContent = `${r.season_start} – ${r.season_end}`;
      byId("height-text").textContent = `${r.vertical_m}m`;
      byId("lift-count-text").textContent = r.lift_count;
      byId("run-count-text").textContent = r.run_count;

      setDiamond("green-run-text", r.green_run, "green");
      setDiamond("blue-run-text", r.blue_run, "blue");
      setDiamond("red-run-text", r.red_run, "red");
      setDiamond("black-run-text", r.black_run, "black");

      ["s","m","l","xl"].forEach(k => setCheck(`${k}-text`, r[`${k}_park`], k.toUpperCase()));
      showStars("condition-text", r.park_condition, 3);
      ["superpipe","minipipe","moguls"].forEach(k => setCheck(`${k}-text`, r[k], k));
      byId("park-description-text").textContent = r.park_description;
      setCheck("has-transport-text", r.has_public_trans, "", false);

      infoBox.classList.add('visible');
    }

    function setDiamond(id, val, color) {
      const el = document.getElementById(id);
      el.innerHTML = val ? `<span class='diamond ${color}'>&#9670;</span> ${val}` : "";
    }

    function setCheck(id, val, label, hideFalse = true) {
      const el = document.getElementById(id);
      if (val === true) {
        el.innerHTML = `<span style="color:green">✔</span> ${label}`;
      } else if (!hideFalse && val === false) {
        el.innerHTML = `<span style="color:red">✘</span> ${label}`;
      } else {
        el.innerHTML = "";
      }
    }

    function showStars(id, value, max = 3) {
      const el = document.getElementById(id);
      if (!value) return el.textContent = "n/a";
      el.innerHTML = "";
      for (let i = 1; i <= max; i++) {
        el.innerHTML += `<span style="color:${i <= value ? 'gold' : '#ccc'}; font-size:1.2em;">${i <= value ? '★' : '☆'}</span>`;
      }
    }

    function applyFilters() {
      const country = document.getElementById('countryInput').value.trim().toLowerCase();
      const filters = ['xl_park', 'l_park','m_park','s_park','superpipe','minipipe','moguls']
        .reduce((acc, id) => ({ ...acc, [id]: document.getElementById(id).checked }), {});
      const [minHeight, maxHeight] = getSliderRange(verticalSlider);
      const [minLift, maxLift] = getSliderRange(liftSlider);
      const [minRun, maxRun] = getSliderRange(runSlider);
      const selectedMonths = Array.from(monthCheckboxes).filter(cb=>cb.checked).map(cb=>parseInt(cb.value));

      
      const visibleMarkers = markers.filter(m => {
        const d = m.data;
        const matchCountry = !country || d.country?.toLowerCase().includes(country);
        const matchParks = Object.entries(filters).every(([k, v]) => !v || d[k]);
        const matchHeight = inRange(d.vertical_m ?? 0, minHeight, maxHeight);
        const matchLift = inRange(d.lift_count ?? 0, minLift, maxLift);
        const matchRun = inRange(d.run_count ?? 0, minRun, maxRun);
        const matchMonths = selectedMonths.every(mo => d.seasonMonths.includes(mo));

        // 🔹 PARK CONDITION FILTER
        const selectedConditions = Array.from(document.querySelectorAll('.park-condition-checkbox'))
                                        .filter(cb => cb.checked)
                                        .map(cb => cb.value);
        const parkCond = d.park_condition ?? 'none';
        const matchCondition = selectedConditions.length === 0 || selectedConditions.includes(String(parkCond));

        return matchCountry && matchParks && matchHeight && matchLift && matchRun && matchMonths && matchCondition;
      });

      // Käy kaikki markerit läpi ja muuta tyyliä sen mukaan, täyttääkö ne filtterit
      markers.forEach(m => {
        if (visibleMarkers.includes(m)) {
          // 🔹 Näkyvät markerit — sininen, etualalle
          m.setStyle({
            color: '#0074D9',
            fillColor: '#0074D9',
            fillOpacity: 1,
            radius: 4
          });
          m.bringToFront(); // tuo marker etualalle
        } else {
          // 🔸 Suodatetut pois — harmaa ja taustalle
          m.setStyle({
            color: '#999',
            fillColor: '#999',
            fillOpacity: 1,
            radius: 3
          });
          m.bringToBack(); // siirrä marker taustalle
        }
      });

    };


    function getSliderRange(slider) {
      return slider.noUiSlider.get().map(v => parseFloat(v));
    }

    function inRange(value, min, max) {
      return value >= min && value <= max;
    }



    let tempMarker = null; // väliaikainen marker geokoodatuille paikoille

    async function handleSearch() {
      const query = searchInput.value.trim().toLowerCase();
      suggestions.innerHTML = '';
      if (!query) return;

      // 1️⃣ ENSIN etsitään resortit
      const resortMatches = markers
        .map(m => {
          const d = m.data;
          if (!d.name) return null;

          const words = d.name.toLowerCase().split(/[\s-]+/);
          const matchIndex = words.findIndex(word => word.startsWith(query));
          return matchIndex !== -1 ? { marker: m, matchIndex } : null;
        })
        .filter(Boolean)
        .sort((a, b) => a.matchIndex - b.matchIndex);

      // Lisätään resortit listaan
      resortMatches.slice(0, 10).forEach(obj => {
        const m = obj.marker;
        const d = m.data;

        const li = document.createElement('li');
        li.classList.add('list-item');
        li.innerHTML = `
          <img src="snowboarder_icon.svg" class="list-icon" alt="skiresort">
          <div>
            <span>${d.name}</span><br>
            ${d.city || d.country
              ? `<span class="subtext">${[d.city, d.country].filter(Boolean).join(', ')}</span>`
              : ''
            }
          </div>
        `;
        li.onclick = () => selectMarker(m);
        suggestions.appendChild(li);
      });

      // 2️⃣ HAETAAN MAAT JA KAUPUNGIT GEOKOODAUKSELLA
      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=20`
        );
        const results = await res.json();
        if (!results.length) return;

        // Suodatetaan maat
        const countries = results.filter(r => {
          if (!r.address?.country) return false;
          const isCountryType = r.type === "country" || (r.class === "boundary" && r.type === "administrative");
          const noCity = !r.address.city && !r.address.town && !r.address.village;
          return isCountryType && noCity;
        });

        // Suodatetaan kaupungit
        const cities = results.filter(r => r.type === "city" || r.type === "town" || r.type === "village");

        const createListItem = r => {
          const li = document.createElement('li');
          li.innerHTML = `
            <p>${r.display_name.split(',')[0]}</p>
            <span class="subtext">${r.display_name}</span>
          `;
          li.onclick = () => {
            if (tempMarker) map.removeLayer(tempMarker);

            const lat = parseFloat(r.lat);
            const lon = parseFloat(r.lon);
            const zoomLevel =
              r.type === "country" ? 5 :
              r.type === "state" ? 7 :
              r.type === "city" || r.type === "town" ? 10 : 12;

            tempMarker = L.marker([lat, lon]).addTo(map)
              .bindPopup(`<strong>${r.display_name}</strong>`)
              .openPopup();

            map.setView([lat, lon], zoomLevel);
            suggestions.innerHTML = '';
          };
          return li;
        };

        // Lisätään maat ja kaupungit resorttien perään
        countries.forEach(r => suggestions.appendChild(createListItem(r)));
        //cities.forEach(r => suggestions.appendChild(createListItem(r)));

      } catch (err) {
        console.error("Geokoodaus epäonnistui:", err);
      }
    }

    function selectMarker(marker) {
      suggestions.innerHTML = '';
      searchInput.value = marker.data.name;
      map.setView([marker.data.lat, marker.data.lon], 14);
      marker.fire('click');
    }

    function debounce(fn, delay = 200) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }


    function selectMarker(marker) {
      suggestions.innerHTML = '';
      searchInput.value = marker.data.name;
      map.setView([marker.data.lat, marker.data.lon], 14);
      marker.fire('click');
    }

    function debounce(fn, delay = 200) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
      };
    }
  

  });

  
  </script>

</body>
</html>